name: Build and Release PDFs

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Build all PDFs
        run: |
          nix develop --command bash -c 'make clean && make all'

      - name: List built PDFs
        run: |
          ls -lh doc/pdf/*.pdf

      - name: Upload PDFs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: software-foundations-pdfs
          path: doc/pdf/*.pdf
          # Note: Artifacts use repository retention settings (max 400 days for public repos)
          # Releases (created for tags) keep PDFs permanently

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: doc/pdf/*.pdf
          body: |
            Software Foundations PDFs - All volumes

            This release contains PDFs for all 6 volumes:
            - **lf.pdf** - Logical Foundations
            - **plf.pdf** - Programming Language Foundations
            - **vfa.pdf** - Verified Functional Algorithms
            - **qc.pdf** - QuickChick: Property-Based Testing
            - **vc.pdf** - Verifiable C
            - **slf.pdf** - Separation Logic Foundations

            Built with Coq/Rocq 9.0 using Nix flakes.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
